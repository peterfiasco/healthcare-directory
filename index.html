<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Directory - ThriveWA</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: #333;
      background: #f8f9fa;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 { color: #00897b; margin-bottom: 10px; font-size: 32px; }
    .intro { color: #666; margin-bottom: 30px; font-size: 16px; }

    .search-filters {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 8px;
      margin-bottom: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 15px;
    }

    .filter-group { display: flex; flex-direction: column; }

    label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
      font-size: 14px;
    }

    input, select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
      background: #fff;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #00897b;
    }

    .provider-grid { display: grid; gap: 20px; }

    .provider-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      transition: all 0.3s;
    }

    .provider-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .provider-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .provider-name {
      font-size: 20px;
      font-weight: 700;
      color: #00897b;
      margin-bottom: 4px;
    }

    .provider-specialty {
      color: #666;
      font-size: 14px;
      font-weight: 500;
    }

    .provider-details {
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .detail-row { display: flex; align-items: start; gap: 10px; }
    .detail-label { font-weight: 700; color: #555; min-width: 140px; font-size: 13px; }
    .detail-value { color: #666; font-size: 13px; }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 14px;
    }

    .tag {
      background: #b2dfdb;
      color: #00695c;
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }

    .btn {
      display: inline-block;
      background: #00897b;
      color: white;
      padding: 10px 14px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.25s;
      font-size: 13px;
    }

    .btn:hover { background: #00695c; }

    .btn.secondary {
      background: #e3f2fd;
      color: #0277bd;
    }

    .btn.secondary:hover {
      background: #d6ecff;
    }

    .no-results {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 16px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #00897b;
      font-size: 18px;
    }

    .error-box {
      margin-top: 10px;
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 12px 14px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      white-space: pre-wrap;
    }

    .disclaimer {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 10px;
      padding: 18px;
      margin-top: 30px;
      font-size: 14px;
      color: #856404;
    }

    .disclaimer strong {
      display: block;
      margin-bottom: 8px;
      color: #856404;
    }

    @media (max-width: 768px) {
      .container { padding: 20px; }
      h1 { font-size: 24px; }
      .search-filters { grid-template-columns: 1fr; }
      .detail-label { min-width: 120px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Community Service Directory</h1>
    <p class="intro">Find organisations and businesses that offer multilingual and culturally responsive support in Western Australia.</p>

    <div class="search-filters">
      <div class="filter-group">
        <label for="searchInput">Search</label>
        <input type="text" id="searchInput" placeholder="Search name, category, location, language..." />
      </div>

      <div class="filter-group">
        <label for="categoryFilter">Service category</label>
        <select id="categoryFilter">
          <option value="">All categories</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="locationFilter">Location</label>
        <select id="locationFilter">
          <option value="">All locations</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="languageFilter">Language supported</label>
        <select id="languageFilter">
          <option value="">All languages</option>
        </select>
      </div>
    </div>

    <div id="loading" class="loading">Loading directory...</div>
    <div id="errorBox" class="error-box"></div>

    <div id="providerGrid" class="provider-grid" style="display:none;"></div>
    <div id="noResults" class="no-results" style="display:none;">No results found matching your filters.</div>

    <div class="disclaimer">
      <strong>Disclaimer</strong>
      This directory lists submitted information for reference only and does not imply endorsement. Details may change.
      Please contact organisations directly to confirm services, costs, and availability.
    </div>
  </div>

  <script>
    // ✅ NEW published CSV (your form responses sheet)
    const RAW_CSV =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeADA3r3KBfdy2wtbdkCwbt5ozm1ZyEGE2jYsAGSDxe1v76vELbXN3iv8-QjnbsKr_ecf1QyeBTBaN/pub?output=csv";

    // ✅ Your Cloudflare Worker proxy
    const WORKER_PROXY = "https://thrivewa-sheets-proxy.wazobia-nigeri.workers.dev/";
    const CSV_URL = WORKER_PROXY + "?url=" + encodeURIComponent(RAW_CSV);

    // Column names (exactly as in your CSV headers)
    const COL = {
      timestamp: "Timestamp",
      org: "Organisation / Business name",
      contactName: "Contact person name",
      email: "Contact email",
      phone: "Phone number",
      website: "Website / Social link",
      category: "Service category",
      categoryOther: "If other, please specify",
      location: "Location (Suburb/City + State)",
      description: "Brief description of service",
      languages: "Languages Supported",
      howLanguage: "How is language support provided?",
      noExtraCost: "Is language support provided at no additional cost to the client?",
      booking: "How should clients book?",
      permission: "Permission to list",
      note: "NOTE: For listing purposes only — please do not share personal or urgent support requests here"
    };

    let allRows = [];
    let filteredRows = [];

    async function loadProviders() {
      const loadingEl = document.getElementById("loading");
      const errorBox = document.getElementById("errorBox");

      try {
        const res = await fetch(CSV_URL, { cache: "no-store" });
        const csvText = await res.text();

        if (!res.ok) throw new Error(`Proxy fetch failed (${res.status}).`);

        if (!looksLikeCSV(csvText)) {
          throw new Error("Response was not CSV. Check: published CSV URL + worker proxy.");
        }

        allRows = parseCSV(csvText);

        // ✅ Only list rows with permission = Yes
        allRows = allRows.filter(r => isYes(r[COL.permission]));

        populateFilters();

        filteredRows = [...allRows];
        renderProviders();

        loadingEl.style.display = "none";
        errorBox.style.display = "none";
        document.getElementById("providerGrid").style.display = "grid";
      } catch (err) {
        console.error(err);
        loadingEl.innerText = "Error loading directory.";
        errorBox.style.display = "block";
        errorBox.textContent =
          "Reason: " + (err?.message || err) + "\n\n" +
          "Test link (should show/download CSV):\n" + CSV_URL;
      }
    }

    function isYes(val) {
      return String(val || "").trim().toLowerCase() === "yes";
    }

    function looksLikeCSV(text) {
      if (!text) return false;
      const t = text.trim();

      // reject HTML or known error text
      if (
        t.startsWith("<!DOCTYPE") ||
        t.startsWith("<html") ||
        t.toLowerCase().includes("sign in") ||
        t.toLowerCase().includes("sorry, the file you have requested does not exist") ||
        t.toLowerCase().includes("missing ?url=")
      ) return false;

      const lines = t.split(/\r?\n/).filter(l => l.trim() !== "");
      if (lines.length < 2) return false;

      const header = lines[0];
      return header.includes(",") && header.split(",").length >= 2;
    }

    // Robust CSV parser (handles commas inside quotes)
    function parseCSV(text) {
      const rows = [];
      let row = [];
      let value = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];

        if (char === '"' && text[i + 1] === '"') {
          value += '"';
          i++;
        } else if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === "," && !inQuotes) {
          row.push(value.trim());
          value = "";
        } else if (char === "\n" && !inQuotes) {
          row.push(value.trim());
          rows.push(row);
          row = [];
          value = "";
        } else {
          value += char;
        }
      }

      if (value.length || row.length) {
        row.push(value.trim());
        rows.push(row);
      }

      const headers = (rows.shift() || []).map(h => h.trim());
      return rows
        .filter(r => r.some(cell => (cell || "").trim() !== ""))
        .map(r => {
          const obj = {};
          headers.forEach((h, idx) => obj[h] = (r[idx] || "").trim());
          return obj;
        });
    }

    // Split list strings into array: supports commas and semicolons
    function normalizeList(str) {
      if (!str) return [];
      return String(str)
        .split(/[;,]/)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function cleanText(s) {
      return String(s || "").trim();
    }

    function escapeHtml(str) {
      return String(str || "").replace(/[&<>"']/g, s => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[s]));
    }

    function safeUrl(url) {
      const u = String(url || "").trim();
      if (!u) return "";
      if (/^https?:\/\//i.test(u)) return u;
      if (/^www\./i.test(u)) return "https://" + u;
      return "";
    }

    function deriveCategory(row) {
      const base = cleanText(row[COL.category]);
      const other = cleanText(row[COL.categoryOther]);
      if (base.toLowerCase() === "other" && other) return other;
      return base || other || "";
    }

    function populateFilters() {
      const categories = [...new Set(
        allRows.map(r => deriveCategory(r)).filter(Boolean)
      )].sort((a,b) => a.localeCompare(b));

      const locations = [...new Set(
        allRows.map(r => cleanText(r[COL.location])).filter(Boolean)
      )].sort((a,b) => a.localeCompare(b));

      const languages = [...new Set(
        allRows.flatMap(r => normalizeList(r[COL.languages]))
      )].sort((a,b) => a.localeCompare(b));

      const categoryFilter = document.getElementById("categoryFilter");
      const locationFilter = document.getElementById("locationFilter");
      const languageFilter = document.getElementById("languageFilter");

      categoryFilter.innerHTML = `<option value="">All categories</option>`;
      locationFilter.innerHTML = `<option value="">All locations</option>`;
      languageFilter.innerHTML = `<option value="">All languages</option>`;

      categories.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        categoryFilter.appendChild(opt);
      });

      locations.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        locationFilter.appendChild(opt);
      });

      languages.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        languageFilter.appendChild(opt);
      });
    }

    function renderProviders() {
      const grid = document.getElementById("providerGrid");
      const noResults = document.getElementById("noResults");
      grid.innerHTML = "";

      if (filteredRows.length === 0) {
        grid.style.display = "none";
        noResults.style.display = "block";
        return;
      }

      grid.style.display = "grid";
      noResults.style.display = "none";

      filteredRows.forEach(row => {
        const org = cleanText(row[COL.org]) || "Untitled Organisation";
        const category = deriveCategory(row);
        const location = cleanText(row[COL.location]);
        const desc = cleanText(row[COL.description]);
        const languages = normalizeList(row[COL.languages]);
        const howLang = cleanText(row[COL.howLanguage]);
        const noExtra = cleanText(row[COL.noExtraCost]);
        const booking = cleanText(row[COL.booking]);

        const website = safeUrl(row[COL.website]);
        const email = cleanText(row[COL.email]);
        const phone = cleanText(row[COL.phone]);
        const contactName = cleanText(row[COL.contactName]);

        const card = document.createElement("div");
        card.className = "provider-card";

        const langTags = languages.slice(0, 10).map(l => `<span class="tag">${escapeHtml(l)}</span>`).join("");

        const actions = [];
        if (website) actions.push(`<a class="btn" href="${website}" target="_blank" rel="noopener">Website</a>`);
        if (email) actions.push(`<a class="btn secondary" href="mailto:${encodeURIComponent(email)}">Email</a>`);
        if (phone) actions.push(`<a class="btn secondary" href="tel:${escapeHtml(phone)}">Call</a>`);

        card.innerHTML = `
          <div class="provider-header">
            <div>
              <div class="provider-name">${escapeHtml(org)}</div>
              <div class="provider-specialty">${escapeHtml(category || "Service")}</div>
            </div>
          </div>

          <div class="provider-details">
            ${location ? `
              <div class="detail-row">
                <span class="detail-label">Location</span>
                <span class="detail-value">${escapeHtml(location)}</span>
              </div>` : ""}

            ${desc ? `
              <div class="detail-row">
                <span class="detail-label">Description</span>
                <span class="detail-value">${escapeHtml(desc)}</span>
              </div>` : ""}

            ${languages.length ? `
              <div class="detail-row">
                <span class="detail-label">Languages</span>
                <span class="detail-value">${escapeHtml(languages.join(", "))}</span>
              </div>` : ""}

            ${howLang ? `
              <div class="detail-row">
                <span class="detail-label">Language support</span>
                <span class="detail-value">${escapeHtml(howLang)}</span>
              </div>` : ""}

            ${noExtra ? `
              <div class="detail-row">
                <span class="detail-label">No extra cost</span>
                <span class="detail-value">${escapeHtml(noExtra)}</span>
              </div>` : ""}

            ${booking ? `
              <div class="detail-row">
                <span class="detail-label">How to book</span>
                <span class="detail-value">${escapeHtml(booking)}</span>
              </div>` : ""}

            ${(contactName || email || phone) ? `
              <div class="detail-row">
                <span class="detail-label">Contact</span>
                <span class="detail-value">
                  ${contactName ? escapeHtml(contactName) : ""}
                  ${contactName && (email || phone) ? " — " : ""}
                  ${email ? escapeHtml(email) : ""}
                  ${email && phone ? " / " : ""}
                  ${phone ? escapeHtml(phone) : ""}
                </span>
              </div>` : ""}
          </div>

          ${languages.length ? `<div class="tags">${langTags}</div>` : ""}
          ${actions.length ? `<div class="actions">${actions.join("")}</div>` : ""}
        `;

        grid.appendChild(card);
      });
    }

    function filterProviders() {
      const q = document.getElementById("searchInput").value.toLowerCase().trim();
      const categoryFilter = document.getElementById("categoryFilter").value;
      const locationFilter = document.getElementById("locationFilter").value;
      const languageFilter = document.getElementById("languageFilter").value;

      filteredRows = allRows.filter(row => {
        const org = cleanText(row[COL.org]).toLowerCase();
        const cat = deriveCategory(row).toLowerCase();
        const loc = cleanText(row[COL.location]).toLowerCase();
        const desc = cleanText(row[COL.description]).toLowerCase();
        const langs = normalizeList(row[COL.languages]).map(x => x.toLowerCase());

        const matchesSearch = !q || (
          org.includes(q) ||
          cat.includes(q) ||
          loc.includes(q) ||
          desc.includes(q) ||
          langs.some(l => l.includes(q))
        );

        const matchesCategory = !categoryFilter || deriveCategory(row) === categoryFilter;
        const matchesLocation = !locationFilter || cleanText(row[COL.location]) === locationFilter;
        const matchesLanguage = !languageFilter || normalizeList(row[COL.languages]).includes(languageFilter);

        return matchesSearch && matchesCategory && matchesLocation && matchesLanguage;
      });

      renderProviders();
    }

    document.getElementById("searchInput").addEventListener("input", filterProviders);
    document.getElementById("categoryFilter").addEventListener("change", filterProviders);
    document.getElementById("locationFilter").addEventListener("change", filterProviders);
    document.getElementById("languageFilter").addEventListener("change", filterProviders);

    loadProviders();
  </script>
</body>
</html>
