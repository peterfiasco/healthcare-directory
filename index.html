<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multilingual Healthcare Directory - ThriveWA</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: #333;
      background: #f8f9fa;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 { color: #00897b; margin-bottom: 10px; font-size: 32px; }
    .intro { color: #666; margin-bottom: 30px; font-size: 16px; }

    .search-filters {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 8px;
      margin-bottom: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .filter-group { display: flex; flex-direction: column; }

    label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
      font-size: 14px;
    }

    input, select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #00897b;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }

    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab:hover { color: #00897b; }
    .tab.active { color: #00897b; border-bottom-color: #00897b; }

    .provider-grid { display: grid; gap: 20px; }

    .provider-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      transition: all 0.3s;
    }

    .provider-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .provider-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .provider-name {
      font-size: 20px;
      font-weight: 600;
      color: #00897b;
      margin-bottom: 5px;
    }

    .provider-specialty { color: #666; font-size: 14px; }

    .provider-details {
      display: grid;
      gap: 10px;
      margin-bottom: 15px;
    }

    .detail-row { display: flex; align-items: start; gap: 10px; }

    .detail-label {
      font-weight: 600;
      color: #555;
      min-width: 80px;
      font-size: 14px;
    }

    .detail-value { color: #666; font-size: 14px; }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 15px;
    }

    .tag {
      background: #b2dfdb;
      color: #00695c;
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 500;
    }

    .contact-btn {
      display: inline-block;
      background: #00897b;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
      transition: background 0.3s;
      margin-top: 10px;
    }

    .contact-btn:hover { background: #00695c; }

    .no-results {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 16px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #00897b;
      font-size: 18px;
    }

    .error-box {
      margin-top: 10px;
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 12px 14px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      white-space: pre-wrap;
    }

    .external-links {
      background: #e3f2fd;
      border-radius: 8px;
      padding: 20px;
      margin-top: 30px;
    }

    .external-links h3 {
      color: #00897b;
      margin-bottom: 15px;
      font-size: 20px;
    }

    .external-links ul { list-style: none; }
    .external-links li { margin-bottom: 10px; }

    .external-links a {
      color: #0277bd;
      text-decoration: none;
    }

    .external-links a:hover { text-decoration: underline; }

    .disclaimer {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 20px;
      margin-top: 30px;
      font-size: 14px;
      color: #856404;
    }

    .disclaimer strong {
      display: block;
      margin-bottom: 10px;
      color: #856404;
    }

    @media (max-width: 768px) {
      .container { padding: 20px; }
      h1 { font-size: 24px; }
      .search-filters { grid-template-columns: 1fr; }
      .tabs { overflow-x: auto; }
      .provider-header { flex-direction: column; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Multilingual Healthcare Directory</h1>
    <p class="intro">Find healthcare providers in Western Australia who offer culturally responsive care and multilingual services.</p>

    <div class="search-filters">
      <div class="filter-group">
        <label for="searchInput">Search by name</label>
        <input type="text" id="searchInput" placeholder="Search provider name..." />
      </div>
      <div class="filter-group">
        <label for="regionFilter">Filter by region</label>
        <select id="regionFilter">
          <option value="">All Regions</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="languageFilter">Filter by language</label>
        <select id="languageFilter">
          <option value="">All Languages</option>
        </select>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-type="all">All Providers</button>
      <button class="tab" data-type="General Practitioner">GPs / Doctors</button>
      <button class="tab" data-type="Psychologist">Psychologists</button>
      <button class="tab" data-type="Allied Health">Allied Health</button>
    </div>

    <div id="loading" class="loading">Loading healthcare providers...</div>
    <div id="errorBox" class="error-box"></div>
    <div id="providerGrid" class="provider-grid" style="display:none;"></div>
    <div id="noResults" class="no-results" style="display:none;">No providers found matching your criteria.</div>

    <div class="external-links">
      <h3>Search More Providers</h3>
      <ul>
        <li><strong>Doctors / GPs (WA):</strong>
          <a href="https://healthengine.com.au" target="_blank" rel="noopener">HealthEngine</a> |
          <a href="https://hotdoc.com.au" target="_blank" rel="noopener">HotDoc</a>
        </li>
        <li><strong>Health services directory:</strong>
          <a href="https://www.healthdirect.gov.au/australian-health-services" target="_blank" rel="noopener">HealthDirect</a>
        </li>
        <li><strong>Psychologists (WA):</strong>
          <a href="https://psychology.org.au/find-a-psychologist" target="_blank" rel="noopener">Australian Psychological Society</a>
        </li>
        <li><strong>WA multicultural health services:</strong>
          <a href="https://www.health.wa.gov.au/Articles/J_M/Multicultural-resources-for-health-professionals/Multicultural-health-services-directory"
             target="_blank" rel="noopener">WA Health Directory</a>
        </li>
      </ul>
    </div>

    <div class="disclaimer">
      <strong>Disclaimer</strong>
      This directory lists publicly available healthcare providers for information only and does not imply endorsement.
      Details including availability, fees, and languages spoken may change. Please contact providers directly to confirm.
      If you are a provider and wish to update or remove your listing, please contact us. ThriveWA does not endorse individual practitioners.
    </div>
  </div>

  <script>
    // ✅ Your Google Sheet (published CSV)
    const RAW_CSV =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTm3jamk8r86opcs7NzKrlhMBDK3SatVNVhukfzQfvEi85X4C8qrb2XIqC9CgPeI4LTiBhjsKAHHyqJ/pub?output=csv";

    // ✅ Your Cloudflare Worker proxy (reliable + CORS enabled)
    const WORKER_PROXY = "https://thrivewa-sheets-proxy.wazobia-nigeri.workers.dev/";

    // ✅ This is what we fetch in the browser
    const CSV_URL = WORKER_PROXY + "?url=" + encodeURIComponent(RAW_CSV);

    let allProviders = [];
    let filteredProviders = [];
    let currentType = "all";

    async function loadProviders() {
      const loadingEl = document.getElementById("loading");
      const errorBox = document.getElementById("errorBox");

      try {
        const response = await fetch(CSV_URL, { cache: "no-store" });
        const csvText = await response.text();

        if (!response.ok) {
          throw new Error(`Proxy fetch failed (${response.status}).`);
        }

        if (!looksLikeCSV(csvText)) {
          throw new Error("Response was not CSV. (Sheet may not be published / wrong URL / proxy blocked)");
        }

        allProviders = parseCSV(csvText);
        populateFilters();
        filteredProviders = [...allProviders];
        renderProviders();

        loadingEl.style.display = "none";
        errorBox.style.display = "none";
        document.getElementById("providerGrid").style.display = "grid";
      } catch (err) {
        console.error(err);
        loadingEl.innerText = "Error loading healthcare providers.";
        errorBox.style.display = "block";
        errorBox.textContent =
          "Reason: " + (err?.message || err) + "\n\n" +
          "Debug tip: open the worker CSV link directly to confirm it returns CSV.\n" +
          "First chars:\n" + (String(err?.rawPreview || "").slice(0, 200) || "(no preview)");
      }
    }

    function looksLikeCSV(text) {
      if (!text) return false;
      const t = text.trim();

      // Reject HTML/error pages
      if (
        t.startsWith("<!DOCTYPE") ||
        t.startsWith("<html") ||
        t.toLowerCase().includes("sign in") ||
        t.toLowerCase().includes("sorry, the file you have requested does not exist") ||
        t.toLowerCase().includes("missing ?url=")
      ) return false;

      // Must have at least 2 non-empty lines
      const lines = t.split(/\r?\n/).filter(l => l.trim() !== "");
      if (lines.length < 2) return false;

      // Header must have multiple columns
      const header = lines[0];
      return header.includes(",") && header.split(",").length >= 2;
    }

    // Robust CSV parser (handles commas inside quotes)
    function parseCSV(text) {
      const rows = [];
      let row = [];
      let value = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];

        if (char === '"' && text[i + 1] === '"') {
          value += '"';
          i++;
        } else if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === "," && !inQuotes) {
          row.push(value.trim());
          value = "";
        } else if (char === "\n" && !inQuotes) {
          row.push(value.trim());
          rows.push(row);
          row = [];
          value = "";
        } else {
          value += char;
        }
      }

      if (value.length || row.length) {
        row.push(value.trim());
        rows.push(row);
      }

      const headers = (rows.shift() || []).map(h => h.trim());
      return rows
        .filter(r => r.some(cell => (cell || "").trim() !== ""))
        .map(r => {
          const obj = {};
          headers.forEach((h, idx) => obj[h] = (r[idx] || "").trim());
          return obj;
        })
        .filter(p => p.Name);
    }

    // ✅ IMPORTANT FIX:
    // Your sheet uses semicolons (;) in Languages/Tags
    // This splits on BOTH commas and semicolons.
    function normalizeList(str) {
      if (!str) return [];
      return str
        .split(/[;,]/)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function populateFilters() {
      const regions = [...new Set(allProviders.map(p => (p.Region || "").trim()).filter(Boolean))].sort();

      const languages = [...new Set(
        allProviders.flatMap(p => normalizeList(p.Languages))
      )].sort();

      const regionFilter = document.getElementById("regionFilter");
      const languageFilter = document.getElementById("languageFilter");

      regionFilter.innerHTML = `<option value="">All Regions</option>`;
      languageFilter.innerHTML = `<option value="">All Languages</option>`;

      regions.forEach(region => {
        const option = document.createElement("option");
        option.value = region;
        option.textContent = region;
        regionFilter.appendChild(option);
      });

      languages.forEach(language => {
        const option = document.createElement("option");
        option.value = language;
        option.textContent = language;
        languageFilter.appendChild(option);
      });
    }

    function escapeHtml(str) {
      return String(str || "").replace(/[&<>"']/g, s => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[s]));
    }

    function safeUrl(url) {
      const u = String(url || "").trim();
      if (!u) return "#";
      if (/^https?:\/\//i.test(u)) return u;
      if (/^www\./i.test(u)) return "https://" + u;
      return "#";
    }

    function renderProviders() {
      const grid = document.getElementById("providerGrid");
      const noResults = document.getElementById("noResults");
      grid.innerHTML = "";

      if (filteredProviders.length === 0) {
        grid.style.display = "none";
        noResults.style.display = "block";
        return;
      }

      grid.style.display = "grid";
      noResults.style.display = "none";

      filteredProviders.forEach(provider => {
        const card = document.createElement("div");
        card.className = "provider-card";

        const tags = normalizeList(provider.Tags);

        card.innerHTML = `
          <div class="provider-header">
            <div>
              <div class="provider-name">${escapeHtml(provider.Name)}</div>
              <div class="provider-specialty">${escapeHtml(provider.Specialty || provider["Provider Type"] || "")}</div>
            </div>
          </div>

          <div class="provider-details">
            ${provider.Region ? `
              <div class="detail-row">
                <span class="detail-label">Region:</span>
                <span class="detail-value">${escapeHtml(provider.Region)}${provider.Location ? " - " + escapeHtml(provider.Location) : ""}</span>
              </div>` : ""}

            ${provider.Languages ? `
              <div class="detail-row">
                <span class="detail-label">Languages:</span>
                <span class="detail-value">${escapeHtml(provider.Languages)}</span>
              </div>` : ""}
          </div>

          ${tags.length ? `
            <div class="tags">
              ${tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join("")}
            </div>` : ""}

          ${provider.Contact ? `
            <a href="${safeUrl(provider.Contact)}" class="contact-btn" target="_blank" rel="noopener">View Profile</a>
          ` : ""}
        `;

        grid.appendChild(card);
      });
    }

    function filterProviders() {
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      const regionFilter = document.getElementById("regionFilter").value;
      const languageFilter = document.getElementById("languageFilter").value;

      filteredProviders = allProviders.filter(provider => {
        const name = (provider.Name || "").toLowerCase();
        const specialty = (provider.Specialty || "").toLowerCase();

        const matchesSearch =
          !searchTerm || name.includes(searchTerm) || specialty.includes(searchTerm);

        const matchesType =
          currentType === "all" ||
          provider["Provider Type"] === currentType ||
          provider.Specialty === currentType;

        const matchesRegion = !regionFilter || provider.Region === regionFilter;

        const providerLanguages = normalizeList(provider.Languages);
        const matchesLanguage = !languageFilter || providerLanguages.includes(languageFilter);

        return matchesSearch && matchesType && matchesRegion && matchesLanguage;
      });

      renderProviders();
    }

    document.getElementById("searchInput").addEventListener("input", filterProviders);
    document.getElementById("regionFilter").addEventListener("change", filterProviders);
    document.getElementById("languageFilter").addEventListener("change", filterProviders);

    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", function () {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        this.classList.add("active");
        currentType = this.dataset.type;
        filterProviders();
      });
    });

    loadProviders();
  </script>
</body>
</html>
