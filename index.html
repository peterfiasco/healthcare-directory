<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Directory - ThriveWA</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: #333;
      background: #f8f9fa;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 { color: #00897b; margin-bottom: 10px; font-size: 32px; }
    .intro { color: #666; margin-bottom: 30px; font-size: 16px; }

    .search-filters {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 8px;
      margin-bottom: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 15px;
    }

    .filter-group { display: flex; flex-direction: column; }

    label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
      font-size: 14px;
    }

    input, select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
      background: #fff;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #00897b;
    }

    .provider-grid { display: grid; gap: 20px; }

    .provider-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      transition: all 0.3s;
    }

    .provider-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .provider-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .provider-name {
      font-size: 20px;
      font-weight: 700;
      color: #00897b;
      margin-bottom: 4px;
    }

    .provider-specialty {
      color: #666;
      font-size: 14px;
      font-weight: 500;
    }

    .provider-details {
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .detail-row { display: flex; align-items: start; gap: 10px; }
    .detail-label { font-weight: 700; color: #555; min-width: 140px; font-size: 13px; }
    .detail-value { color: #666; font-size: 13px; }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 14px;
    }

    .tag {
      background: #b2dfdb;
      color: #00695c;
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }

    .btn {
      display: inline-block;
      background: #00897b;
      color: white;
      padding: 10px 14px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.25s;
      font-size: 13px;
    }

    .btn:hover { background: #00695c; }

    .btn.secondary {
      background: #e3f2fd;
      color: #0277bd;
    }

    .btn.secondary:hover { background: #d6ecff; }

    .no-results {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 16px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #00897b;
      font-size: 18px;
    }

    .error-box {
      margin-top: 10px;
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 12px 14px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      white-space: pre-wrap;
    }

    .disclaimer {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 10px;
      padding: 18px;
      margin-top: 30px;
      font-size: 14px;
      color: #856404;
    }

    .disclaimer strong {
      display: block;
      margin-bottom: 8px;
      color: #856404;
    }

    @media (max-width: 768px) {
      .container { padding: 20px; }
      h1 { font-size: 24px; }
      .search-filters { grid-template-columns: 1fr; }
      .detail-label { min-width: 120px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Community Service Directory</h1>
    <p class="intro">Find organisations and businesses that offer multilingual and culturally responsive support in Western Australia.</p>

    <div class="search-filters">
      <div class="filter-group">
        <label for="searchInput">Search</label>
        <input type="text" id="searchInput" placeholder="Search name, category, location, language..." />
      </div>

      <div class="filter-group">
        <label for="categoryFilter">Service category</label>
        <select id="categoryFilter">
          <option value="">All categories</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="locationFilter">Location</label>
        <select id="locationFilter">
          <option value="">All locations</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="languageFilter">Language supported</label>
        <select id="languageFilter">
          <option value="">All languages</option>
        </select>
      </div>
    </div>

    <div id="loading" class="loading">Loading directory...</div>
    <div id="errorBox" class="error-box"></div>

    <div id="providerGrid" class="provider-grid" style="display:none;"></div>
    <div id="noResults" class="no-results" style="display:none;">No results found matching your filters.</div>

    <div class="disclaimer">
      <strong>Disclaimer</strong>
      This directory lists submitted information for reference only and does not imply endorsement. Details may change.
      Please contact organisations directly to confirm services, costs, and availability.
    </div>
  </div>

  <script>
    // ✅ Working Approved CSV (gid) — you confirmed this works
    const DIRECT_APPROVED_CSV =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeADA3r3KBfdy2wtbdkCwbt5ozm1ZyEGE2jYsAGSDxe1v76vELbXN3iv8-QjnbsKr_ecf1QyeBTBaN/pub?output=csv&gid=794819936&single=true";

    // ✅ Your worker (also confirmed working with the pub CSV URL)
    const WORKER_PROXY = "https://thrivewa-sheets-proxy.wazobia-nigeri.workers.dev/";
    const CSV_URL = WORKER_PROXY + "?url=" + encodeURIComponent(DIRECT_APPROVED_CSV);

    // If there ARE headers, we use these candidates
    const COL = {
      org: ["Organisation / Business name", "Organisation / Employer name", "Organisation"],
      email: ["Contact email", "Contact email (for enquiries)", "Email"],
      phone: ["Phone number", "Phone"],
      website: ["Website / Social link", "Website"],
      category: ["Service category", "Category"],
      categoryOther: ["If other, please specify", "Other"],
      location: ["Location (Suburb/City + State)", "Location"],
      description: ["Brief description of service", "Description"],
      languages: ["Languages Supported", "Languages"],
      howLanguage: ["How is language support provided?", "Language support provided"],
      noExtraCost: ["Is language support provided at no additional cost to the client?", "No extra cost"],
      booking: ["How should clients book?", "How to book"],
      permission: ["Permission to list"],
      status: ["Status"]
    };

    // If NO headers, map by position (A..S) with fallbacks:
    // Many rows have blank Org early, but Org exists later (e.g. "Clinic 55", "Life Source Clinics")
    const IDX = {
      timestamp: 0,
      orgPrimary: 1,        // B
      contactPrimary: 2,    // C
      email: 3,             // D
      phone: 4,             // E
      website: 5,           // F
      category: 6,          // G
      categoryOther: 7,     // H
      location: 8,          // I
      description: 9,       // J
      languages: 10,        // K
      howLanguage: 11,      // L
      noExtraCost: 12,      // M
      booking: 13,          // N
      permission: 14,       // O
      orgFallback: 16,      // Q (your sample: "Clinic 55", "Life Source Clinics", etc.)
      contactFallback: 17,  // R (your sample: "Dr Ifunanya...", "Abiodun Agara", etc.)
      status: 18            // S (Approved)
    };

    let allRows = [];
    let filteredRows = [];

    async function loadProviders() {
      const loadingEl = document.getElementById("loading");
      const errorBox = document.getElementById("errorBox");

      try {
        const res = await fetch(CSV_URL, { cache: "no-store" });
        const csvText = await res.text();

        if (!res.ok) throw new Error(`Proxy fetch failed (${res.status}).\nURL: ${CSV_URL}`);

        const parsed = parseCSVWithRows(csvText);

        const hasHeaders = looksLikeHeaderRow(parsed.headers);

        allRows = hasHeaders
          ? parsed.objects
          : parsed.rows.map(r => rowFromIndexes(r));

        // ✅ Show only safe rows:
        // - Status must be Approved (if present)
        // - Permission must be Yes (if present)
        // - Must have some identity (org OR website OR email OR phone)
        allRows = allRows.filter(r => {
          const perm = getVal(r, COL.permission) || r.__permission || "";
          const status = getVal(r, COL.status) || r.__status || "";

          const permissionOk = perm ? isYes(perm) : true;
          const statusOk = status ? String(status).trim().toLowerCase() === "approved" : true;

          const org = getVal(r, COL.org) || r.__org || "";
          const website = getVal(r, COL.website) || r.__website || "";
          const email = getVal(r, COL.email) || r.__email || "";
          const phone = getVal(r, COL.phone) || r.__phone || "";

          const hasIdentity = !!(org || website || email || phone);
          return permissionOk && statusOk && hasIdentity;
        });

        populateFilters();
        filteredRows = [...allRows];
        renderProviders();

        loadingEl.style.display = "none";
        errorBox.style.display = "none";
        document.getElementById("providerGrid").style.display = "grid";
      } catch (err) {
        console.error(err);
        loadingEl.innerText = "Error loading directory.";
        errorBox.style.display = "block";
        errorBox.textContent =
          "Reason:\n" + (err?.message || err) + "\n\n" +
          "Direct CSV test:\n" + DIRECT_APPROVED_CSV + "\n\n" +
          "Proxy test:\n" + CSV_URL;
      }
    }

    function looksLikeHeaderRow(headers) {
      // More strict header detection - look for actual column names
      const joined = headers.join("|").toLowerCase();
      const hasExpectedHeaders = 
        joined.includes("organisation") && 
        joined.includes("email") && 
        joined.includes("phone") && 
        joined.includes("category");
      
      // Also check if first header looks like a timestamp (indicating data row)
      const firstHeader = headers[0]?.toLowerCase() || "";
      const looksLikeTimestamp = /^\d{1,2}\/\d{1,2}\/\d{4}/.test(firstHeader);
      
      return hasExpectedHeaders && !looksLikeTimestamp;
    }

    function parseCSVWithRows(text) {
      const rows = [];
      let row = [];
      let value = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (ch === '"' && text[i + 1] === '"') { value += '"'; i++; }
        else if (ch === '"') inQuotes = !inQuotes;
        else if (ch === "," && !inQuotes) { row.push(value.trim()); value = ""; }
        else if (ch === "\n" && !inQuotes) { row.push(value.trim()); rows.push(row); row = []; value = ""; }
        else value += ch;
      }
      if (value.length || row.length) { row.push(value.trim()); rows.push(row); }

      const headers = (rows.shift() || []).map(h => (h || "").trim());
      const dataRows = rows.filter(r => r.some(cell => (cell || "").trim() !== ""));

      const objects = dataRows.map(r => {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = (r[idx] || "").trim());
        return obj;
      });

      return { headers, rows: dataRows, objects };
    }

    function rowFromIndexes(r) {
      const org = (r[IDX.orgPrimary] || "").trim() || (r[IDX.orgFallback] || "").trim();
      const contact = (r[IDX.contactPrimary] || "").trim() || (r[IDX.contactFallback] || "").trim();

      return {
        __org: org,
        __contactName: contact,
        __email: (r[IDX.email] || "").trim(),
        __phone: (r[IDX.phone] || "").trim(),
        __website: (r[IDX.website] || "").trim(),
        __category: (r[IDX.category] || "").trim(),
        __categoryOther: (r[IDX.categoryOther] || "").trim(),
        __location: (r[IDX.location] || "").trim(),
        __description: (r[IDX.description] || "").trim(),
        __languages: (r[IDX.languages] || "").trim(),
        __howLanguage: (r[IDX.howLanguage] || "").trim(),
        __noExtraCost: (r[IDX.noExtraCost] || "").trim(),
        __booking: (r[IDX.booking] || "").trim(),
        __permission: (r[IDX.permission] || "").trim(),
        __status: (r[IDX.status] || "").trim(),
      };
    }

    function getVal(row, candidates) {
      for (const key of candidates) {
        const v = row[key];
        if (v != null && String(v).trim() !== "") return String(v).trim();
      }
      return "";
    }

    function isYes(val) {
      return String(val || "").trim().toLowerCase() === "yes";
    }

    function normalizeList(str) {
      if (!str) return [];
      return String(str).split(/[;,]/).map(s => s.trim()).filter(Boolean);
    }

    function escapeHtml(str) {
      return String(str || "").replace(/[&<>"']/g, s => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[s]));
    }

    function safeUrl(url) {
      const u = String(url || "").trim();
      if (!u) return "";
      if (/^https?:\/\//i.test(u)) return u;
      if (/^www\./i.test(u)) return "https://" + u;
      if (/^[a-z0-9.-]+\.[a-z]{2,}/i.test(u)) return "https://" + u;
      return "";
    }

    function deriveCategory(row) {
      const base = getVal(row, COL.category) || row.__category || "";
      const other = getVal(row, COL.categoryOther) || row.__categoryOther || "";
      if (base && base.toLowerCase() === "other" && other) return other;
      return base || other || "";
    }

    function getOrg(row) {
      return getVal(row, COL.org) || row.__org || "";
    }
    function getLocation(row) {
      return getVal(row, COL.location) || row.__location || "";
    }
    function getLanguages(row) {
      return getVal(row, COL.languages) || row.__languages || "";
    }
    function getDescription(row) {
      return getVal(row, COL.description) || row.__description || "";
    }
    function getHowLang(row) {
      return getVal(row, COL.howLanguage) || row.__howLanguage || "";
    }
    function getNoExtra(row) {
      return getVal(row, COL.noExtraCost) || row.__noExtraCost || "";
    }
    function getBooking(row) {
      return getVal(row, COL.booking) || row.__booking || "";
    }
    function getWebsite(row) {
      return getVal(row, COL.website) || row.__website || "";
    }
    function getEmail(row) {
      return getVal(row, COL.email) || row.__email || "";
    }
    function getPhone(row) {
      return getVal(row, COL.phone) || row.__phone || "";
    }

    function populateFilters() {
      const categories = [...new Set(allRows.map(r => deriveCategory(r)).filter(Boolean))].sort((a,b) => a.localeCompare(b));
      const locations = [...new Set(allRows.map(r => getLocation(r)).filter(Boolean))].sort((a,b) => a.localeCompare(b));
      const languages = [...new Set(allRows.flatMap(r => normalizeList(getLanguages(r))))].sort((a,b) => a.localeCompare(b));

      const categoryFilter = document.getElementById("categoryFilter");
      const locationFilter = document.getElementById("locationFilter");
      const languageFilter = document.getElementById("languageFilter");

      categoryFilter.innerHTML = `<option value="">All categories</option>`;
      locationFilter.innerHTML = `<option value="">All locations</option>`;
      languageFilter.innerHTML = `<option value="">All languages</option>`;

      categories.forEach(v => categoryFilter.appendChild(new Option(v, v)));
      locations.forEach(v => locationFilter.appendChild(new Option(v, v)));
      languages.forEach(v => languageFilter.appendChild(new Option(v, v)));
    }

    function renderProviders() {
      const grid = document.getElementById("providerGrid");
      const noResults = document.getElementById("noResults");
      grid.innerHTML = "";

      if (filteredRows.length === 0) {
        grid.style.display = "none";
        noResults.style.display = "block";
        return;
      }

      grid.style.display = "grid";
      noResults.style.display = "none";

      filteredRows.forEach(row => {
        const org = getOrg(row) || "Untitled Organisation";
        const category = deriveCategory(row) || "Service";
        const location = getLocation(row);
        const desc = getDescription(row);

        const languages = normalizeList(getLanguages(row));
        const howLang = getHowLang(row);
        const noExtra = getNoExtra(row);
        const booking = getBooking(row);

        const website = safeUrl(getWebsite(row));
        const email = (getEmail(row) || "").trim();
        const phone = (getPhone(row) || "").trim();

        const actions = [];
        if (website) actions.push(`<a class="btn" href="${website}" target="_blank" rel="noopener">Website</a>`);
        if (email) actions.push(`<a class="btn secondary" href="mailto:${encodeURIComponent(email)}">Email</a>`);
        if (phone) actions.push(`<a class="btn secondary" href="tel:${escapeHtml(phone)}">Call</a>`);

        const card = document.createElement("div");
        card.className = "provider-card";
        card.innerHTML = `
          <div class="provider-header">
            <div>
              <div class="provider-name">${escapeHtml(org)}</div>
              <div class="provider-specialty">${escapeHtml(category)}</div>
            </div>
          </div>

          <div class="provider-details">
            ${location ? `
              <div class="detail-row">
                <span class="detail-label">Location</span>
                <span class="detail-value">${escapeHtml(location)}</span>
              </div>` : ""}

            ${desc ? `
              <div class="detail-row">
                <span class="detail-label">Description</span>
                <span class="detail-value">${escapeHtml(desc)}</span>
              </div>` : ""}

            ${languages.length ? `
              <div class="detail-row">
                <span class="detail-label">Languages</span>
                <span class="detail-value">${escapeHtml(languages.join(", "))}</span>
              </div>` : ""}

            ${howLang ? `
              <div class="detail-row">
                <span class="detail-label">Language support</span>
                <span class="detail-value">${escapeHtml(howLang)}</span>
              </div>` : ""}

            ${noExtra ? `
              <div class="detail-row">
                <span class="detail-label">No extra cost</span>
                <span class="detail-value">${escapeHtml(noExtra)}</span>
              </div>` : ""}

            ${booking ? `
              <div class="detail-row">
                <span class="detail-label">How to book</span>
                <span class="detail-value">${escapeHtml(booking)}</span>
              </div>` : ""}
          </div>

          ${languages.length ? `
            <div class="tags">
              ${languages.slice(0, 12).map(l => `<span class="tag">${escapeHtml(l)}</span>`).join("")}
            </div>` : ""}

          ${actions.length ? `<div class="actions">${actions.join("")}</div>` : ""}
        `;

        grid.appendChild(card);
      });
    }

    function filterProviders() {
      const q = document.getElementById("searchInput").value.toLowerCase().trim();
      const categoryFilter = document.getElementById("categoryFilter").value;
      const locationFilter = document.getElementById("locationFilter").value;
      const languageFilter = document.getElementById("languageFilter").value;

      filteredRows = allRows.filter(row => {
        const org = getOrg(row).toLowerCase();
        const cat = deriveCategory(row).toLowerCase();
        const loc = getLocation(row).toLowerCase();
        const desc = getDescription(row).toLowerCase();
        const langs = normalizeList(getLanguages(row)).map(x => x.toLowerCase());

        const matchesSearch = !q || (
          org.includes(q) ||
          cat.includes(q) ||
          loc.includes(q) ||
          desc.includes(q) ||
          langs.some(l => l.includes(q))
        );

        const matchesCategory = !categoryFilter || deriveCategory(row) === categoryFilter;
        const matchesLocation = !locationFilter || getLocation(row) === locationFilter;
        const matchesLanguage = !languageFilter || normalizeList(getLanguages(row)).includes(languageFilter);

        return matchesSearch && matchesCategory && matchesLocation && matchesLanguage;
      });

      renderProviders();
    }

    document.getElementById("searchInput").addEventListener("input", filterProviders);
    document.getElementById("categoryFilter").addEventListener("change", filterProviders);
    document.getElementById("locationFilter").addEventListener("change", filterProviders);
    document.getElementById("languageFilter").addEventListener("change", filterProviders);

    loadProviders();
  </script>
</body>
</html>
